<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="实用技术," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="多线程简介进程：进程是描述一个程序的执行过程，是应用程序的一个实例(一个应用程序或软件可以有多个进程)。它是操作系统分配资源的基本单元，即拥有自己的地址空间、存储空间。线程：线程是操作系统独立运行和独立调度的基本单位，可以理解为程序执行过程中的子过程，这个子过程可是并行也可串行(一个进程至少有一个线程)。多线程：多线程是一种用来提高CPU运行效率的一种技术，往往提现为一个进程中分配了不止一条线程在">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS多线程的使用总结">
<meta property="og:url" content="http://yoursite.com/2017/04/15/iOS多线程的使用总结/index.html">
<meta property="og:site_name" content="CoderHann">
<meta property="og:description" content="多线程简介进程：进程是描述一个程序的执行过程，是应用程序的一个实例(一个应用程序或软件可以有多个进程)。它是操作系统分配资源的基本单元，即拥有自己的地址空间、存储空间。线程：线程是操作系统独立运行和独立调度的基本单位，可以理解为程序执行过程中的子过程，这个子过程可是并行也可串行(一个进程至少有一个线程)。多线程：多线程是一种用来提高CPU运行效率的一种技术，往往提现为一个进程中分配了不止一条线程在">
<meta property="og:updated_time" content="2017-08-02T16:01:50.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS多线程的使用总结">
<meta name="twitter:description" content="多线程简介进程：进程是描述一个程序的执行过程，是应用程序的一个实例(一个应用程序或软件可以有多个进程)。它是操作系统分配资源的基本单元，即拥有自己的地址空间、存储空间。线程：线程是操作系统独立运行和独立调度的基本单位，可以理解为程序执行过程中的子过程，这个子过程可是并行也可串行(一个进程至少有一个线程)。多线程：多线程是一种用来提高CPU运行效率的一种技术，往往提现为一个进程中分配了不止一条线程在">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/04/15/iOS多线程的使用总结/"/>





  <title> iOS多线程的使用总结 | CoderHann </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">CoderHann</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle">coderHann’s blog</p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/15/iOS多线程的使用总结/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="CoderHann">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://github.com/CoderHann/imageSource/blob/master/Blog/blog_usr_icon.jpeg?raw=true">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="CoderHann">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="CoderHann" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                iOS多线程的使用总结
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-04-15T21:11:57+08:00">
                2017-04-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/04/15/iOS多线程的使用总结/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/04/15/iOS多线程的使用总结/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/04/15/iOS多线程的使用总结/" class="leancloud_visitors" data-flag-title="iOS多线程的使用总结">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="多线程简介"><a href="#多线程简介" class="headerlink" title="多线程简介"></a>多线程简介</h3><p><strong>进程</strong>：进程是描述一个程序的执行过程，是应用程序的一个实例(一个应用程序或软件可以有多个进程)。它是操作系统分配资源的基本单元，即拥有自己的地址空间、存储空间。<br><strong>线程</strong>：线程是操作系统独立运行和独立调度的基本单位，可以理解为程序执行过程中的子过程，这个子过程可是并行也可串行(一个进程至少有一个线程)。<br><strong>多线程</strong>：多线程是一种用来提高CPU运行效率的一种技术，往往提现为一个进程中分配了不止一条线程在执行任务，而是多条线程并发执行。</p>
<p>上面以自己的理解对<code>进程</code>、<code>线程</code>和<code>多线程</code>概念的概括，需要详细了解相关知识的请自行Google、百度进行查阅。本文主要是以自己对多线程的理解进行梳理，如果有不对的地方请及时<a href="/about/">联系我</a>更正。</p>
<a id="more"></a>
<h3 id="生活中的多线程"><a href="#生活中的多线程" class="headerlink" title="生活中的多线程"></a>生活中的多线程</h3><p>其实多线程在我们的生活中有很多,如果说做饭是一个进程的话。我们把这个进程分成煲汤和煮面这两个线程(排骨汤配面条绝了😝)，不会说把它们放到一个线程中依次进行，而是两个线程并发去完成，这样可以提高我们的执行效率。</p>
<p>上面的一个生活中的小例子只是概括的想象下程序的多线程是什么样子的，下面这个例子主要体现在多线程的处理效率上的提升：</p>
<p>上学的时候，同学们上完上午的课之后一起涌进食堂。如果食堂只有一个窗口，吃饭的人多了肯定会有很多人排队吃饭，这样的效率应该是最低的。食堂改革了新增了N个窗口提供用餐，我们可以将这种多窗口的改革称之为多线程的使用。这种方式能够解决执行效率低下的情况，排队时间缩短了M倍！除此之外，一个学校可能不止有一个食堂可能有第二、第三食堂，我们可以把这种情况看做是多核心处理。多核处理能让我们的执行效率得到更一步的提升！</p>
<p>上面叙述的目的就是让大家对多线程有一个直观的认识以及多线程处理性能高的优点。下面让我们了解下iOS开发中常用的多线程相关技术吧。</p>
<h3 id="iOS多线程的分类以及详解"><a href="#iOS多线程的分类以及详解" class="headerlink" title="iOS多线程的分类以及详解"></a>iOS多线程的分类以及详解</h3><h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><p>iOS开发中提供了<a href="#pthread">pthread</a>、<a href="#NSThread">NSThread</a>、<a href="#GCD">GCD</a>，<a href="#NSOperation">NSOperation</a>这四种方式来使用多线程。其中<code>GCD</code>，<code>NSOperation</code>使用频率比较高，将花费本博客的一大部分篇幅。而<code>pthread</code>在普通日常开发中很少遇到，这里将仅仅介绍相关的简单使用方法。<code>NSThread</code>在开发中用的频率也比较低，它是以面向对象的方式来处理多线程的。下面我们分别就这四种方式进行详细的介绍。</p>
<h4 id="pthread"><a href="#pthread" class="headerlink" title="pthread"></a><a id="pthread"></a>pthread</h4><p>pthread由于开发中很少使用(基本没用过)，所以这里只是对它做一个简单介绍，然后使用它调起多线程。</p>
<p><strong>pthread的介绍参考百科如下：</strong><br>POSIX线程（POSIX threads），简称Pthreads，是线程的POSIX标准。该标准定义了创建和操纵线程的一整套API。在类Unix操作系统（Unix、Linux、Mac OS X等）中，都使用Pthreads作为操作系统的线程。Windows操作系统也有其移植版pthreads-win32。</p>
<p><strong>使用pthread开启多线程：</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 1.导入头文件</span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;pthread.h&gt;</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)aMethod &#123;</div><div class="line">    <span class="comment">// 2.创建线程变量</span></div><div class="line">    pthread_t pthread;</div><div class="line">    </div><div class="line">    <span class="comment">// 3.1创建线程</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">long</span> times = <span class="number">10000</span>L;</div><div class="line">    pthread_create(&amp;pthread, <span class="literal">NULL</span>, run, &amp;times);</div><div class="line">    </div><div class="line">&#125;</div><div class="line"><span class="comment">// 3.2线程指定调用c函数(耗时操作)</span></div><div class="line"><span class="keyword">void</span>* run(<span class="keyword">void</span>* times) &#123;</div><div class="line">    </div><div class="line">    <span class="keyword">long</span> executeCount = *(<span class="keyword">long</span> *)times;</div><div class="line">    </div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; executeCount; index++) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"耗时任务正在执行：%d times on thread:%@"</span>,index,[<span class="built_in">NSThread</span> currentThread]);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>pthread_create()有四个参数：<br>1.<code>pthread_t *</code>：指向线程变量的指针<br>2.<code>const pthread_attr_t *</code>：指向线程属性的常量指针<br>3.<code>void * (*)(void *)</code>：指向返回值为<code>void *</code>,入参为<code>void *</code>的c函数(线程要执行的任务)<br>4.<code>void *</code>：指向任务函数的入参指针</p>
<p>上面代码模拟了在开发中不影响主线程的情况下，开启子线程处理耗时操作(对应这里的打印10000次log)。其实这里还有很多问题，比如我们创建线程执行完任务后没有将该线程释放。我们可以在子线程任务结束的时候调用<code>pthread_detach(pthread_self());</code>让线程运行结束后自动释放资源。</p>
<p>pthread这种方式使用c语言，以及需要程序猿自己管理线程的生命周期，大大降低了我们的开发速率。日常普通开发不推荐使用此方式，如果你想了解更多pthread相关知识请百度或谷歌寻找答案！</p>
<h4 id="NSThread"><a href="#NSThread" class="headerlink" title="NSThread"></a><a id="NSThread"></a>NSThread</h4><p><code>NSThread</code>在开发中还是比较常见的，起码<code>[NSThread currentThread]</code>大家都用过。相比于pthread的简单介绍，这里我们将通过<code>NSThread基础用法</code>、<code>线程的生命周期</code>、<code>线程间的通讯</code>以及一个<code>多线程的数据访问控制</code>对NSThread进行详细讲解。</p>
<h5 id="NSThread基础用法"><a href="#NSThread基础用法" class="headerlink" title="NSThread基础用法"></a>NSThread基础用法</h5><h6 id="NSThread的实例化"><a href="#NSThread的实例化" class="headerlink" title="NSThread的实例化"></a>NSThread的实例化</h6><p><code>NSThread</code>的实例对象作为一个线程的实例，我们所有的操作都是基于这个实例对象，那这样的实例对象该如何创建呢：<br>①使用类方法创建线程：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** 该方法创建一个新的线程并执行selector对应的方法体</span></div><div class="line"> * selector: 对应要执行的方法体</div><div class="line"> * target: 执行方法的对象</div><div class="line"> * argument: 给target的参数</div><div class="line"> */</div><div class="line">+ (<span class="keyword">void</span>)detachNewThreadSelector:(SEL)selector toTarget:(<span class="keyword">id</span>)target withObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>)argument;</div><div class="line"></div><div class="line"><span class="comment">// iOS10新增了使用block对应的方法，block内为要在新线程执行的代码/任务</span></div><div class="line">+ (<span class="keyword">void</span>)detachNewThreadWithBlock:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))block;</div></pre></td></tr></table></figure></p>
<p>类方法创建的线程都没有返回对应的线程对象，如果要对该线程对象进行操作可以在对应的方法体中通过<code>[NSThread currentThread]</code>获取当前线程。</p>
<p>②使用对象方法创建线程：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 创建一个线程对象并返回`AThread`</span></div><div class="line">- (<span class="keyword">instancetype</span>)initWithTarget:(<span class="keyword">id</span>)target selector:(SEL)selector object:(<span class="keyword">nullable</span> <span class="keyword">id</span>)argument;</div><div class="line"><span class="comment">// iOS10新增的对象方法，它接受一个block用来处理要执行的代码/任务</span></div><div class="line">- (<span class="keyword">instancetype</span>)initWithBlock:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))block;</div></pre></td></tr></table></figure></p>
<p>使用②中的对象方法创建的线程不会立即执行，需要对创建的线程对象调用start方法:<code>[aThread start]</code></p>
<p>③使用NSObject的分类方法创建线程：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">NSThreadPerformAdditions</span>)</span></div><div class="line"></div><div class="line"><span class="comment">/** 该方法将创建一个线程，并执行aSelector对应的方法体。</span></div><div class="line"> * aSelector: 对应调用此方法对象的一个方法体</div><div class="line"> * arg: 给aSelector选择器传递的参数</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)performSelectorInBackground:(SEL)aSelector withObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>)arg;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>NSThread相关的实例化方法正如上面的三种分类所示，了解了创建线程实例对象后，我们要深入线程对象从对象相关的属性、用法来介绍。</p>
<h6 id="NSThread常用属性-amp-方法"><a href="#NSThread常用属性-amp-方法" class="headerlink" title="NSThread常用属性&amp;方法"></a>NSThread常用属性&amp;方法</h6><p>该小节主要介绍官方提供的我们经常使用的那些类属性、类方法、对象属性、对象方法，来了解NSThread都有哪些功能。<br><strong>常用的类属性&amp;方法：</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 获得当前执行任务所在的线程</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">class</span>, <span class="keyword">readonly</span>, <span class="keyword">strong</span>) <span class="built_in">NSThread</span> *currentThread;</div><div class="line"></div><div class="line"><span class="comment">// 判断当前线程是否是主线程</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">class</span>, <span class="keyword">readonly</span>) <span class="built_in">BOOL</span> isMainThread;</div><div class="line"></div><div class="line"><span class="comment">// 获得主线程</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">class</span>, <span class="keyword">readonly</span>, <span class="keyword">strong</span>) <span class="built_in">NSThread</span> *mainThread;</div></pre></td></tr></table></figure></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 线程暂停</span></div><div class="line">+ (<span class="keyword">void</span>)sleepUntilDate:(<span class="built_in">NSDate</span> *)date;</div><div class="line">+ (<span class="keyword">void</span>)sleepForTimeInterval:(<span class="built_in">NSTimeInterval</span>)ti;</div><div class="line"></div><div class="line"><span class="comment">// 线程终止，调用此方法会将所有非主线程的线程杀掉</span></div><div class="line">+ (<span class="keyword">void</span>)exit;</div></pre></td></tr></table></figure>
<p><strong>常用的对象属性&amp;方法：</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 当前线程名字</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name</div><div class="line"><span class="comment">/** 线程优先级枚举，需在线程开始前设置否则无效，枚举值如下、优先级依次降低：</span></div><div class="line"> * NSQualityOfServiceUserInteractive: 用于用户交互事件以及UI的刷新</div><div class="line"> * NSQualityOfServiceUserInitiated: 用于用户需要进一步执行的事件(在用户在邮件列表中选择邮件后，加载电子邮件。)</div><div class="line"> * NSQualityOfServiceDefault: 默认分配的优先级（根据任务来源推断优先级，如无法推断，优先级介于UserInitiated和Utility之间）</div><div class="line"> * NSQualityOfServiceUtility: 用于执行用户不太可能立即等待结果的工作(周期性内容更新或大容量文件操作，如媒体导入.)</div><div class="line"> * NSQualityOfServiceBackground: 用于非用户发起或可见的工作(预取内容，搜索索引、备份和同步与外部系统的数据。)</div><div class="line"> */</div><div class="line"><span class="keyword">@property</span> <span class="built_in">NSQualityOfService</span> qualityOfService;</div><div class="line"></div><div class="line"><span class="comment">// 判断当前线程是否是主线程</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">BOOL</span> isMainThread;</div><div class="line"></div><div class="line"><span class="comment">// 线程状态:是否正在执行，是否已经完成，是否已经取消</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">getter</span>=isExecuting) <span class="built_in">BOOL</span> executing;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">getter</span>=isFinished) <span class="built_in">BOOL</span> finished;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">getter</span>=isCancelled) <span class="built_in">BOOL</span> cancelled;</div></pre></td></tr></table></figure></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 线程开始执行</span></div><div class="line">- (<span class="keyword">void</span>)start;</div><div class="line"></div><div class="line"><span class="comment">// 取消线程</span></div><div class="line">- (<span class="keyword">void</span>)cancel;</div></pre></td></tr></table></figure>
<p>至此NSThread的实例创建以及基本功能大家都了解了，至少能使用NSThread开启一个线程做任务了。下面将对线程相关进行扩展，讲述<code>线程的生命周期</code>是怎么在NSThread中体现的。</p>
<h5 id="线程的生命周期"><a href="#线程的生命周期" class="headerlink" title="线程的生命周期"></a>线程的生命周期</h5><p>像很多的实例对象一样，线程也有自己的生命周期。线程的生命周期简单的来说就是线程的创建到线程的销毁的过程。本小节将围绕这个过程存在的状态：<code>创建</code>、<code>就绪</code>、<code>运行</code>、<code>阻塞</code>，<code>销毁</code>进行讲解。</p>
<p>创建：创建一个线程对象，在调用start方法之前的状态。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 创建：aThread被创建</span></div><div class="line"><span class="built_in">NSThread</span> *aThread = [[<span class="built_in">NSThread</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(downloadImage) object:<span class="literal">nil</span>];</div></pre></td></tr></table></figure></p>
<p>就绪：就绪状态在代码中的常见形式是调用了start方法即：<code>[aThread start]</code>，该状态描述的是线程对象已加入就绪队列中并等待CPU的资源。就绪状态也可描述为可运行状态，是运行状态的前一个必有的状态。该状态除了调用start方法还有很多其它情况，比如线程睡眠结束、共享资源锁的释放，IO操作完成等。</p>
<p>运行：当就绪的线程aThread得到CPU的资源时就会将线程对象激活进入运行状态，处理代码逻辑。</p>
<p>阻塞：阻塞是在线程运行中由于某种原因失去CPU资源的结果。常见的这些原因主要有：线程睡眠，IO操作，等待线程/锁。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 阻塞：线程暂停3秒</span></div><div class="line">- (<span class="keyword">void</span>)downloadImage &#123;</div><div class="line">    <span class="comment">// xxx代码</span></div><div class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">3</span>];</div><div class="line">    <span class="comment">// xxx代码</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>销毁：销毁即线程的死亡状态，通常是运行完成后自动销毁，或者在运行期间调用了exit方法导致线程被结束。</p>
<p>线程的生命周期作为扩展小节，目的是让大家更好的理解线程是如何工作的，也为我们以后的开发能更好的处理问题提供线索。接下来讲述平常开发中常见的情景：线程间的通讯，来了解下各个线程如何沟通或者传递数据。</p>
<h5 id="NSThread线程间的通讯"><a href="#NSThread线程间的通讯" class="headerlink" title="NSThread线程间的通讯"></a>NSThread线程间的通讯</h5><p>前面我们也说到了一个进程可以有多条线程在执行任务，这些线程之间的关系可能是相互独立的各自完成相应的任务，也有依赖关系的通常表现在一个线程所产生的数据，消息等通知给另一个线程。比如：用线程A去加载一个比较大的图片，加载完成后需要告诉主线程将图片渲染在屏幕上，我们把这种线程中的数据交流称为<strong>线程间的通讯</strong>。</p>
<p>NSThread线程通讯的常用方式：<br>在NSObject的<code>NSThreadPerformAdditions</code>分类中提供了从一个线程调起另一个线程的方法，下面我们将围绕这几个方法进行介绍，最后以一个例子结束线程通讯模块。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** 到thr线程执行aSelector选择器指定的方法</span></div><div class="line"> * aSelector: 一个选择器，对应要执行的代码方法</div><div class="line"> * thr: 指定的线程对象</div><div class="line"> * arg: aSelector所需要接受收的参数</div><div class="line"> * wait: 是否阻塞当前线程，直到指定线程thr执行完aSelector对应的方法后再执行下面其它代码。</div><div class="line"> * array: 循环队列(run loop)参数数组kCFRunLoopDefaultMode，kCFRunLoopCommonModes</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)performSelector:(SEL)aSelector onThread:(<span class="built_in">NSThread</span> *)thr withObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>)arg waitUntilDone:(<span class="built_in">BOOL</span>)wait modes:(<span class="keyword">nullable</span> <span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *)array;</div></pre></td></tr></table></figure></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 该方法是上一个方法array参数为kCFRunLoopCommonModes的情况，具体参数参照如上</span></div><div class="line">- (<span class="keyword">void</span>)performSelector:(SEL)aSelector onThread:(<span class="built_in">NSThread</span> *)thr withObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>)arg waitUntilDone:(<span class="built_in">BOOL</span>)wait;</div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 到主线程执行aSelector选择器指定的方法，参数可参考第一个方法</span></div><div class="line">- (<span class="keyword">void</span>)performSelectorOnMainThread:(SEL)aSelector withObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>)arg waitUntilDone:(<span class="built_in">BOOL</span>)wait modes:(<span class="keyword">nullable</span> <span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *)array;</div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// array参数为kCFRunLoopCommonModes的情况</span></div><div class="line">- (<span class="keyword">void</span>)performSelectorOnMainThread:(SEL)aSelector withObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>)arg waitUntilDone:(<span class="built_in">BOOL</span>)wait;</div></pre></td></tr></table></figure>
<p>下面代码主要演示主线程绘画一个UIImageView，而它的图片来自于互联网需要开启一个异步线程去下载，当图片下载好之后需要主线程将图片再渲染到屏幕上，这样来模拟线程间的通讯的。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    </div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="comment">// 绘画imageView</span></div><div class="line">    <span class="built_in">UIImageView</span> *imageView = [[<span class="built_in">UIImageView</span> alloc] init];</div><div class="line">    imageView.frame = <span class="built_in">CGRectMake</span>(<span class="number">100</span>, <span class="number">100</span>, <span class="number">100</span>, <span class="number">100</span>);</div><div class="line">    imageView.backgroundColor = [<span class="built_in">UIColor</span> grayColor];</div><div class="line">    [<span class="keyword">self</span>.view addSubview:imageView];</div><div class="line">    _imageView = imageView;</div><div class="line">    </div><div class="line">    <span class="comment">// 开启线程开启下载任务</span></div><div class="line">    <span class="built_in">NSThread</span> *aThread = [[<span class="built_in">NSThread</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(downloadImage) object:<span class="literal">nil</span>];</div><div class="line">    [aThread start];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 子线程下载图片方法</span></div><div class="line">- (<span class="keyword">void</span>)downloadImage &#123;</div><div class="line">    <span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:<span class="string">@"https://raw.githubusercontent.com/CoderHann/imageSource/master/Blog/blog_usr_icon.jpeg"</span>];</div><div class="line">    <span class="built_in">NSURLRequest</span> *request = [<span class="built_in">NSURLRequest</span> requestWithURL:url cachePolicy:<span class="built_in">NSURLRequestReloadIgnoringLocalCacheData</span> timeoutInterval:<span class="number">60</span>];</div><div class="line">    </div><div class="line">    <span class="built_in">NSURLSessionDataTask</span> *dataTask = [[<span class="built_in">NSURLSession</span> sharedSession] dataTaskWithRequest:request completionHandler:^(<span class="built_in">NSData</span> * _Nullable data, <span class="built_in">NSURLResponse</span> * _Nullable response, <span class="built_in">NSError</span> * _Nullable error) &#123;</div><div class="line">        </div><div class="line">        <span class="comment">// 网络访问成功</span></div><div class="line">        <span class="keyword">if</span> (data &amp;&amp; (error == <span class="literal">nil</span>)) &#123;</div><div class="line">            </div><div class="line">            <span class="built_in">UIImage</span> *image = [<span class="built_in">UIImage</span> imageWithData:data];</div><div class="line">            [<span class="keyword">self</span> performSelectorOnMainThread:<span class="keyword">@selector</span>(updateImage:) withObject:image waitUntilDone:<span class="literal">NO</span>];</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line">    </div><div class="line">    [dataTask resume];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 更新_imageView图片</span></div><div class="line">- (<span class="keyword">void</span>)updateImage:(<span class="built_in">UIImage</span> *)image &#123;</div><div class="line">    _imageView.image = image;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里注意下<code>dataTaskWithRequest: completionHandler:</code>这个方法的block代码也是异步调用的，虽然不在我们指定的线程中通知主线程进行刷新UI，但是不影响我们进行线程间通信的演示。</p>
<h5 id="NSThread数据访问控制-同步"><a href="#NSThread数据访问控制-同步" class="headerlink" title="NSThread数据访问控制/同步"></a>NSThread数据访问控制/同步</h5><p>多线程环境下存在同时访问共享数据的情况，如果不对数据的访问进行处理/限制极有可能造成数据混乱或是数据处理异常。这里我们引用经典的买票案例演示多线程访问存在的问题，以及解决办法。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 卖票相关初始化</span></div><div class="line">- (<span class="keyword">void</span>)prepareForSale &#123;</div><div class="line">    </div><div class="line">    <span class="comment">// 北京窗口</span></div><div class="line">    <span class="built_in">NSThread</span> *beijing = [[<span class="built_in">NSThread</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(saleTickets) object:<span class="literal">nil</span>];</div><div class="line">    beijing.name = <span class="string">@"北京"</span>;</div><div class="line">    </div><div class="line">    <span class="comment">// 上海窗口</span></div><div class="line">    <span class="built_in">NSThread</span> *shanghai = [[<span class="built_in">NSThread</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(saleTickets) object:<span class="literal">nil</span>];</div><div class="line">    shanghai.name = <span class="string">@"上海"</span>;</div><div class="line">    </div><div class="line">    <span class="comment">// 监听线程的退出，判断卖票是否结束</span></div><div class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(threadWillExit) name:<span class="built_in">NSThreadWillExitNotification</span> object:<span class="literal">nil</span>];</div><div class="line">    _leftTicketNum = <span class="number">10</span>;</div><div class="line">    </div><div class="line">    <span class="comment">// 开始售票</span></div><div class="line">    [beijing start];</div><div class="line">    [shanghai start];</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 售票</span></div><div class="line">- (<span class="keyword">void</span>)saleTickets &#123;</div><div class="line">    </div><div class="line">    <span class="keyword">while</span> (_leftTicketNum &gt; <span class="number">0</span>) &#123;</div><div class="line">        </div><div class="line">        _leftTicketNum--;</div><div class="line">        <span class="built_in">NSThread</span> *thread = [<span class="built_in">NSThread</span> currentThread];</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@卖出一张票,剩余%zd张"</span>,thread.name,_leftTicketNum);</div><div class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">0.2</span>];</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div><div class="line"><span class="comment">// 卖票结束即线程销毁</span></div><div class="line">- (<span class="keyword">void</span>)threadWillExit &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@卖票结束"</span>,[<span class="built_in">NSThread</span> currentThread].name);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">11.297</span> MultiThreadDemo[<span class="number">3564</span>:<span class="number">228402</span>] 上海卖出一张票,剩余<span class="number">8</span>张</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">11.297</span> MultiThreadDemo[<span class="number">3564</span>:<span class="number">228401</span>] 北京卖出一张票,剩余<span class="number">9</span>张</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">11.499</span> MultiThreadDemo[<span class="number">3564</span>:<span class="number">228401</span>] 北京卖出一张票,剩余<span class="number">7</span>张</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">11.499</span> MultiThreadDemo[<span class="number">3564</span>:<span class="number">228402</span>] 上海卖出一张票,剩余<span class="number">7</span>张</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">11.702</span> MultiThreadDemo[<span class="number">3564</span>:<span class="number">228401</span>] 北京卖出一张票,剩余<span class="number">6</span>张</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">11.702</span> MultiThreadDemo[<span class="number">3564</span>:<span class="number">228402</span>] 上海卖出一张票,剩余<span class="number">5</span>张</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">11.905</span> MultiThreadDemo[<span class="number">3564</span>:<span class="number">228402</span>] 上海卖出一张票,剩余<span class="number">3</span>张</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">11.905</span> MultiThreadDemo[<span class="number">3564</span>:<span class="number">228401</span>] 北京卖出一张票,剩余<span class="number">4</span>张</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">12.110</span> MultiThreadDemo[<span class="number">3564</span>:<span class="number">228401</span>] 北京卖出一张票,剩余<span class="number">2</span>张</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">12.110</span> MultiThreadDemo[<span class="number">3564</span>:<span class="number">228402</span>] 上海卖出一张票,剩余<span class="number">2</span>张</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">12.312</span> MultiThreadDemo[<span class="number">3564</span>:<span class="number">228401</span>] 北京卖出一张票,剩余<span class="number">1</span>张</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">12.312</span> MultiThreadDemo[<span class="number">3564</span>:<span class="number">228402</span>] 上海卖出一张票,剩余<span class="number">0</span>张</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">12.517</span> MultiThreadDemo[<span class="number">3564</span>:<span class="number">228402</span>] 上海卖票结束</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">12.517</span> MultiThreadDemo[<span class="number">3564</span>:<span class="number">228401</span>] 北京卖票结束</div></pre></td></tr></table></figure>
<p>上面代码演示了北京和上海两地同时卖票的情况，结果打印的数据存在着问题，而造成这种问题的原因是线程间共享数据的读和存不同步。比如上海读取票数为10，在上海修改票数之前北京读取也为10，这样两个窗口卖了两张票之后总票数还为9。通常处理这种问题的方案是给这个读存操作加锁，即在一个窗口A访问数据时其他窗口不能访问该数据直到A访问完成。</p>
<p>解决方案：对售票<code>saleTickets</code>业务访问共享数据的逻辑加锁操作：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 售票</span></div><div class="line">- (<span class="keyword">void</span>)saleTickets &#123;</div><div class="line">    </div><div class="line">    <span class="keyword">while</span> (_leftTicketNum &gt; <span class="number">0</span>) &#123;</div><div class="line">        </div><div class="line">        <span class="keyword">@synchronized</span> (<span class="keyword">self</span>) &#123;</div><div class="line">            _leftTicketNum--;</div><div class="line">            <span class="built_in">NSThread</span> *thread = [<span class="built_in">NSThread</span> currentThread];</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%@卖出一张票,剩余%zd张"</span>,thread.name,_leftTicketNum);</div><div class="line">        &#125;</div><div class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">0.2</span>];</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行结果如下：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">35</span>:<span class="number">29.410</span> MultiThreadDemo[<span class="number">744</span>:<span class="number">14961</span>] 北京卖出一张票,剩余<span class="number">9</span>张</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">35</span>:<span class="number">29.410</span> MultiThreadDemo[<span class="number">744</span>:<span class="number">14962</span>] 上海卖出一张票,剩余<span class="number">8</span>张</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">35</span>:<span class="number">29.613</span> MultiThreadDemo[<span class="number">744</span>:<span class="number">14961</span>] 北京卖出一张票,剩余<span class="number">7</span>张</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">35</span>:<span class="number">29.614</span> MultiThreadDemo[<span class="number">744</span>:<span class="number">14962</span>] 上海卖出一张票,剩余<span class="number">6</span>张</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">35</span>:<span class="number">29.817</span> MultiThreadDemo[<span class="number">744</span>:<span class="number">14962</span>] 上海卖出一张票,剩余<span class="number">5</span>张</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">35</span>:<span class="number">29.818</span> MultiThreadDemo[<span class="number">744</span>:<span class="number">14961</span>] 北京卖出一张票,剩余<span class="number">4</span>张</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">35</span>:<span class="number">30.019</span> MultiThreadDemo[<span class="number">744</span>:<span class="number">14961</span>] 北京卖出一张票,剩余<span class="number">3</span>张</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">35</span>:<span class="number">30.019</span> MultiThreadDemo[<span class="number">744</span>:<span class="number">14962</span>] 上海卖出一张票,剩余<span class="number">2</span>张</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">35</span>:<span class="number">30.223</span> MultiThreadDemo[<span class="number">744</span>:<span class="number">14961</span>] 北京卖出一张票,剩余<span class="number">1</span>张</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">35</span>:<span class="number">30.224</span> MultiThreadDemo[<span class="number">744</span>:<span class="number">14962</span>] 上海卖出一张票,剩余<span class="number">0</span>张</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">35</span>:<span class="number">30.429</span> MultiThreadDemo[<span class="number">744</span>:<span class="number">14962</span>] 上海卖票结束</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">35</span>:<span class="number">30.429</span> MultiThreadDemo[<span class="number">744</span>:<span class="number">14961</span>] 北京卖票结束</div></pre></td></tr></table></figure></p>
<p>可以看出对共享数据访问加锁的方式成功解决了数据混乱的问题。在iOS开发中加锁的方式不只是使用<code>@synchronized(){}</code>还有其他类型的锁这里不一一介绍，有兴趣的童鞋可以搜搜相关博客介绍。</p>
<p>到此NSThread的相关知识点从基本介绍到多线程数据的访问限制已经比较全面的讲述了一番，因为NSThread的轻型以及面向对象开发方式，总体来看使用NSThread操作多线程是还比较容易上手的。在其优点的对面当然也有它的不足：我们需要管理线程的生命周期，对共享数据加锁开销比较大。NSThread相关介绍到此结束，下面让我们看看开发中使用频率非常高的<code>GCD</code>吧！</p>
<h4 id="GCD"><a href="#GCD" class="headerlink" title="GCD"></a><a id="GCD"></a>GCD</h4><p>GCD是<code>Grand Central Dispatch</code>的缩写，由苹果公司开发的优化多核处理器的技术。它的基本思想是将线程的管理从开发中分离出去，让开发者更专注于自己的业务开发。在日常开发中经常使用GCD处理多线程相关业务，所以学会使用GCD是非常重要的。按照NSThread的套路我们仍然从基础开始由浅入深的对GCD进行讲解，力求大家看完GCD章节内容后能熟练的使用它。本节将通过：<code>GCD相关概念</code>、<code>常用API</code>、<code>GCD的基本使用</code>、<code>线程间通信</code>，<code>数据访问控制</code>对GCD进行详细讲解。</p>
<h5 id="GCD相关概念"><a href="#GCD相关概念" class="headerlink" title="GCD相关概念"></a>GCD相关概念</h5><p>因为GCD执行的方式是将任务放入队列中进行同步/异步执行，所以在使用GCD之前，我们先对<code>任务</code>和<code>队列</code>这两个核心概念进行了解。</p>
<p><strong>任务：</strong>简单的说我们要执行的代码片段要完成的业务就是一个任务，而开发中这些任务一般是处理一些耗时的操作。通常任务都被描述为被执行的，在GCD中执行任务分为两种形式：<code>同步执行</code>，<code>异步执行</code>。同步执行不具备开启新线程的能力，就在原线程中执行任务。而异步执行是具备开启新线程的能力的，但是开不开、开几条线程是跟队列相关的，后面我们会在<code>GCD的基本使用</code>小节中详细介绍他们的用法。</p>
<p><strong>队列：</strong>这里的队列是用来存放任务的，也称为任务队列。GCD中分为<code>串行队列</code>、<code>并行队列</code>两类。串行队列其特点是一个任务执行完了才执行下一个任务遵循队列的先进先出原则，而并行队列在异步执行的情况下可将各个任务依照先进先出原则并发执行。</p>
<p>概念补充：<br><strong>并发执行：</strong>并发描述为多个事件在同一时间间隔内发生。由于CPU的处理速度非常快，CPU完全有能力在短暂的时间间隔内完成多条线程的切换以及各个线程部分任务的执行。并发能够有效提升CPU的执行效率。</p>
<p><strong>并行执行：</strong>并行描述为多个事件在同一时间点发生。并行执行发生在拥有多核处理器的设备上，在同一时间点不同的处理器执行不同的线程不同的任务。并行的多核处理器仿佛拥有多个心脏/引擎一样拥有更强大的’动力’，结合并发执行能够显著提升任务的执行率。</p>
<h5 id="GCD基础"><a href="#GCD基础" class="headerlink" title="GCD基础"></a>GCD基础</h5><p>在了解了基本的概念之后我们主要通过<code>队列</code>、<code>同步异步执行</code>来了解GCD的使用。</p>
<h6 id="队列"><a href="#队列" class="headerlink" title="队列"></a>队列</h6><p>队列在GCD中的类型为<code>dispatch_queue_t</code>，本小节将围绕队列的创建、使用和特性进行讲解。队列除了按照性质分类的串行和并行队列，我们还可以将队列分为<code>主队列</code>、<code>全局队列</code>和<code>自定义队列</code>下面让我们以这三种分类对队列进行介绍。</p>
<p>主队列：即主线程队列，在我们的开发中主线程即UI线程。主队列为串行队列，在开发中无法自定义创建，其获取方式可以使用官方提供的API<code>dispatch_get_main_queue()</code>获取如下：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 主队列的获取方式</span></div><div class="line"><span class="built_in">dispatch_queue_t</span> mainQueue = dispatch_get_main_queue();</div></pre></td></tr></table></figure></p>
<p>全局队列：是系统提供方便编程的一个并行队列，其获取方式使用<code>dispatch_get_global_queue(long identifier, unsigned long flags)</code>。其中有两个参数<code>identifier</code>，<code>flags</code>分别表示队列的优先级以及预留参数。<br>identifier优先级分了四个等级，在NSThread章节讲过创建的线程我们也可以给它设置优先级，那么这两块的优先级有什么联系呢，下面针对GCD全局队列的四个等级进行映射：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">DISPATCH_QUEUE_PRIORITY_HIGH: <span class="built_in">NSQualityOfServiceUserInitiated</span></div><div class="line">DISPATCH_QUEUE_PRIORITY_DEFAULT: <span class="built_in">NSQualityOfServiceDefault</span></div><div class="line">DISPATCH_QUEUE_PRIORITY_LOW: <span class="built_in">NSQualityOfServiceUtility</span></div><div class="line">DISPATCH_QUEUE_PRIORITY_BACKGROUND: <span class="built_in">NSQualityOfServiceBackground</span></div></pre></td></tr></table></figure></p>
<p>对应的优先级关系可参考NSThread线程优先级介绍，由于全局队列处理一些耗时/后台的一些操作，其优先级并没有提供与NSQualityOfServiceUserInteractive对应的刷新UI的优先级。</p>
<p>flags预留参数：该参数作为预留参数现阶段开发中并没有什么用，但是官方提到<code>Passing any value other than zero may result in a NULL return value.</code>大概意思就是如果此处传参不为0可能返回一个NULL的队列，所以开发中这个参数我们都写0即可。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 全局队列的创建</span></div><div class="line"><span class="built_in">dispatch_queue_t</span> highQueue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, <span class="number">0</span>);</div><div class="line"><span class="built_in">dispatch_queue_t</span> highQueue2 = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, <span class="number">0</span>);</div><div class="line"></div><div class="line"><span class="built_in">dispatch_queue_t</span> defaultQueue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</div><div class="line"></div><div class="line"><span class="built_in">dispatch_queue_t</span> lowQueue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_LOW, <span class="number">0</span>);</div><div class="line"></div><div class="line"><span class="built_in">dispatch_queue_t</span> backgroundQueue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_BACKGROUND, <span class="number">0</span>);</div><div class="line"><span class="built_in">dispatch_queue_t</span> backgroundQueue2 = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_BACKGROUND, <span class="number">0</span>);</div><div class="line"></div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"highQueue:%p"</span>,highQueue);</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"highQueue2:%p"</span>,highQueue2);</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"defaultQueue:%p"</span>,defaultQueue);</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"lowQueue:%p"</span>,lowQueue);</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"backgroundQueue:%p"</span>,backgroundQueue);</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"backgroundQueue2:%p"</span>,backgroundQueue2);</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// 对应的log</span></div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">11</span>:<span class="number">00</span>:<span class="number">31.952</span> MultiThreadDemo[<span class="number">1552</span>:<span class="number">107092</span>] highQueue:<span class="number">0x10e3ea540</span></div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">11</span>:<span class="number">00</span>:<span class="number">31.953</span> MultiThreadDemo[<span class="number">1552</span>:<span class="number">107092</span>] highQueue2:<span class="number">0x10e3ea540</span></div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">11</span>:<span class="number">00</span>:<span class="number">31.953</span> MultiThreadDemo[<span class="number">1552</span>:<span class="number">107092</span>] defaultQueue:<span class="number">0x10e3ea3c0</span></div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">11</span>:<span class="number">00</span>:<span class="number">31.953</span> MultiThreadDemo[<span class="number">1552</span>:<span class="number">107092</span>] lowQueue:<span class="number">0x10e3ea240</span></div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">11</span>:<span class="number">00</span>:<span class="number">31.953</span> MultiThreadDemo[<span class="number">1552</span>:<span class="number">107092</span>] backgroundQueue:<span class="number">0x10e3ea0c0</span></div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">11</span>:<span class="number">00</span>:<span class="number">31.953</span> MultiThreadDemo[<span class="number">1552</span>:<span class="number">107092</span>] backgroundQueue2:<span class="number">0x10e3ea0c0</span></div></pre></td></tr></table></figure>
<p>根据打印的log我们发现了一个问题，就是相同优先级获取到的队列是同一个队列，而不同优先级获取的队列地址是不同的。也就是说全局队列不止一个队列对象是四种不同优先级的四个全局队列组成的。</p>
<p>自定义队列：除了使用系统提供的主队列和全局队列，我们还可以根据自己的需求创建队列，自定义队列也是分串行队列和并行队列的，下面让我们看看自定义队列如何创建：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 创建串行队列DISPATCH_QUEUE_SERIAL</span></div><div class="line"><span class="built_in">dispatch_queue_t</span> serialQueue = dispatch_queue_create(<span class="string">"serialQueue"</span>, DISPATCH_QUEUE_SERIAL);</div><div class="line"></div><div class="line"><span class="comment">// 创建并行队列DISPATCH_QUEUE_CONCURRENT</span></div><div class="line"><span class="built_in">dispatch_queue_t</span> concurrentQueue = dispatch_queue_create(<span class="string">"concurrentQueue"</span>, DISPATCH_QUEUE_CONCURRENT);</div></pre></td></tr></table></figure></p>
<p><code>dispatch_queue_create(const char *label,dispatch_queue_attr_t attr)</code>方法提供了两个入参：label为线程唯一标示方便于debug找问题，attr是队列属性用于控制创建的队列是串行（DISPATCH_QUEUE_SERIAL）还是并行（DISPATCH_QUEUE_CONCURRENT）的。</p>
<h6 id="同步异步执行"><a href="#同步异步执行" class="headerlink" title="同步异步执行"></a>同步异步执行</h6><p>到现在我们已经知道如何创建不同类型的队列，那么我们如何执行队列中的任务呢。GCD中提供了同步执行和异步执行任务，同步和异步执行的特点在GCD概念介绍的时候已经讲过这里不再赘述。下面让我看看两种方式的使用吧：</p>
<p>同步执行：<code>dispatch_sync(dispatch_queue_t queue, ^(void)block)</code>同步执行方法接收两个参数，queue指定要在哪个任务队列中执行，block所指代码块为要执行的任务。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">dispatch_sync</span>(defaultQueue, ^&#123;</div><div class="line">    <span class="comment">// 任务代码</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>异步执行：<code>dispatch_async(dispatch_queue_t queue, ^(void)block)</code>和同步执行方法类似也拥有相同的入参，请参考同步执行入参介绍。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">dispatch_async</span>(defaultQueue, ^&#123;</div><div class="line">    <span class="comment">// 任务代码</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>下面将结合串行并行队列诠释同步与异步执行的不同：<br>同步+串行队列：不会开启新线程，任务遵循先进先出方式依次执行。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="comment">// 串行队列创建</span></div><div class="line">    <span class="built_in">dispatch_queue_t</span> serialQueue = dispatch_queue_create(<span class="string">"serialQueue"</span>, DISPATCH_QUEUE_SERIAL);</div><div class="line">    </div><div class="line">    <span class="built_in">dispatch_sync</span>(serialQueue, ^&#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"task1--%@"</span>,[<span class="built_in">NSThread</span> currentThread]);</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    <span class="built_in">dispatch_sync</span>(serialQueue, ^&#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"task2--%@"</span>,[<span class="built_in">NSThread</span> currentThread]);</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    <span class="built_in">dispatch_sync</span>(serialQueue, ^&#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"task3--%@"</span>,[<span class="built_in">NSThread</span> currentThread]);</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    <span class="built_in">dispatch_sync</span>(serialQueue, ^&#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"task4--%@"</span>,[<span class="built_in">NSThread</span> currentThread]);</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 对应的log</span></div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">15</span>:<span class="number">28</span>:<span class="number">56.691</span> MultiThreadDemo[<span class="number">16842</span>:<span class="number">220632</span>] task1--&lt;<span class="built_in">NSThread</span>: <span class="number">0x60800006b940</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">15</span>:<span class="number">28</span>:<span class="number">56.692</span> MultiThreadDemo[<span class="number">16842</span>:<span class="number">220632</span>] task2--&lt;<span class="built_in">NSThread</span>: <span class="number">0x60800006b940</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">15</span>:<span class="number">28</span>:<span class="number">56.692</span> MultiThreadDemo[<span class="number">16842</span>:<span class="number">220632</span>] task3--&lt;<span class="built_in">NSThread</span>: <span class="number">0x60800006b940</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">15</span>:<span class="number">28</span>:<span class="number">56.692</span> MultiThreadDemo[<span class="number">16842</span>:<span class="number">220632</span>] task4--&lt;<span class="built_in">NSThread</span>: <span class="number">0x60800006b940</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</div></pre></td></tr></table></figure></p>
<p>前面讲队列的时候我们说了主队列也是属于串行队列的，如果同步执行相同队列中的任务会是什么样的情况呢，下面展示主线程中在主队列中执行任务：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="built_in">dispatch_queue_t</span> mainQueue = dispatch_get_main_queue();</div><div class="line">    </div><div class="line">    <span class="built_in">dispatch_sync</span>(mainQueue, ^&#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"task1--%@"</span>,[<span class="built_in">NSThread</span> currentThread]);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行的结果是程序crash了<code>EXC_BAD_INSTRUCTION(code=EXC_I386_INVOP,subcode=0x0)</code>，因为同步串行执行需等前一个任务有返回值或者说结束了才会去执行下一个任务，示例中添加的task1在串行队列的最后面，前一个任务没有执行完要接着执行，而此时又要立即执行task1，出现了任务互等相互死锁都执行不了。</p>
<p>主队列是一个比较特殊的串行队列，那是不是一般的串行队列也有这样的问题呢：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="comment">// 串行队列创建</span></div><div class="line">    <span class="built_in">dispatch_queue_t</span> serialQueue = dispatch_queue_create(<span class="string">"serialQueue"</span>, DISPATCH_QUEUE_SERIAL);</div><div class="line">    </div><div class="line">    <span class="built_in">dispatch_async</span>(serialQueue, ^&#123;</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"task1 start"</span>);</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"task1--%@"</span>,[<span class="built_in">NSThread</span> currentThread]);</div><div class="line">        </div><div class="line">        <span class="built_in">dispatch_sync</span>(serialQueue, ^&#123;</div><div class="line">           </div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"task2--%@"</span>,[<span class="built_in">NSThread</span> currentThread]);</div><div class="line">        &#125;);</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"task1 end"</span>);</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 打印的log</span></div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">22</span>:<span class="number">27</span>:<span class="number">37.243</span> MultiThreadDemo[<span class="number">808</span>:<span class="number">37406</span>] task1 start</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">22</span>:<span class="number">27</span>:<span class="number">39.606</span> MultiThreadDemo[<span class="number">808</span>:<span class="number">37406</span>] task1--&lt;<span class="built_in">NSThread</span>: <span class="number">0x60000007a600</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</div></pre></td></tr></table></figure></p>
<p>这里发生了相同的crash，也就是说同步执行相同串行队列的任务时会发生死锁，所以在多线程开发中不要走这种雷区。不过这种情况一般人也不会这样写，直接插入对应的任务代码即可何必再用GCD同步执行该任务呢！文章中提这种问题就是一种对GCD用法的研究，小伙伴们不要太在意。</p>
<p>同步+并行队列：不会开启新的线程，虽然队列是并行队列但是同步执行不具备开启新线程的条件，所以只能在该线程中依次执行。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="comment">// 创建并行队列</span></div><div class="line">    <span class="built_in">dispatch_queue_t</span> concurrentQueue = dispatch_queue_create(<span class="string">"concurrentQueue"</span>, DISPATCH_QUEUE_CONCURRENT);</div><div class="line">    </div><div class="line">    <span class="built_in">dispatch_sync</span>(concurrentQueue, ^&#123;</div><div class="line">       </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"task1--%@"</span>,[<span class="built_in">NSThread</span> currentThread]);</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    <span class="built_in">dispatch_sync</span>(concurrentQueue, ^&#123;</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"task2--%@"</span>,[<span class="built_in">NSThread</span> currentThread]);</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    <span class="built_in">dispatch_sync</span>(concurrentQueue, ^&#123;</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"task3--%@"</span>,[<span class="built_in">NSThread</span> currentThread]);</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    <span class="built_in">dispatch_sync</span>(concurrentQueue, ^&#123;</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"task4--%@"</span>,[<span class="built_in">NSThread</span> currentThread]);</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    <span class="comment">// 嵌套同步并行执行</span></div><div class="line">    <span class="built_in">dispatch_sync</span>(concurrentQueue, ^&#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"task5 start"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"task5--%@"</span>,[<span class="built_in">NSThread</span> currentThread]);</div><div class="line">        </div><div class="line">        <span class="built_in">dispatch_sync</span>(concurrentQueue, ^&#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"task6--%@"</span>,[<span class="built_in">NSThread</span> currentThread]);</div><div class="line">        &#125;);</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"task5 end"</span>);</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">01</span>:<span class="number">40.527</span> MultiThreadDemo[<span class="number">1087</span>:<span class="number">69003</span>] task1--&lt;<span class="built_in">NSThread</span>: <span class="number">0x60800007a140</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">01</span>:<span class="number">40.527</span> MultiThreadDemo[<span class="number">1087</span>:<span class="number">69003</span>] task2--&lt;<span class="built_in">NSThread</span>: <span class="number">0x60800007a140</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">01</span>:<span class="number">40.527</span> MultiThreadDemo[<span class="number">1087</span>:<span class="number">69003</span>] task3--&lt;<span class="built_in">NSThread</span>: <span class="number">0x60800007a140</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">01</span>:<span class="number">40.527</span> MultiThreadDemo[<span class="number">1087</span>:<span class="number">69003</span>] task4--&lt;<span class="built_in">NSThread</span>: <span class="number">0x60800007a140</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">01</span>:<span class="number">40.527</span> MultiThreadDemo[<span class="number">1087</span>:<span class="number">69003</span>] task5 start</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">01</span>:<span class="number">40.528</span> MultiThreadDemo[<span class="number">1087</span>:<span class="number">69003</span>] task5--&lt;<span class="built_in">NSThread</span>: <span class="number">0x60800007a140</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">01</span>:<span class="number">40.528</span> MultiThreadDemo[<span class="number">1087</span>:<span class="number">69003</span>] task6--&lt;<span class="built_in">NSThread</span>: <span class="number">0x60800007a140</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">01</span>:<span class="number">40.528</span> MultiThreadDemo[<span class="number">1087</span>:<span class="number">69003</span>] task5 end</div></pre></td></tr></table></figure>
<p>如上同步并行执行，由于没有开启新的线程，task1-6在主线程中顺序执行，由嵌套同步并行执行代码可看出放入到并行队列的任务会立即执行，直到执行完成才接着做原来任务继续执行（同步执行下）。</p>
<p>异步+串行队列：可以开启一条线程，任务在串行队列中依次被执行。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="comment">// 创建串行队列</span></div><div class="line">    __block <span class="built_in">dispatch_queue_t</span> serialQueue = dispatch_queue_create(<span class="string">"serialQueue"</span>, DISPATCH_QUEUE_SERIAL);</div><div class="line">    </div><div class="line">    <span class="built_in">dispatch_async</span>(serialQueue, ^&#123;</div><div class="line">       </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"task1--%@"</span>,[<span class="built_in">NSThread</span> currentThread]);</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> (<span class="built_in">NSInteger</span> index = <span class="number">0</span>; index &lt; <span class="number">5</span>; index++) &#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"task1--run%zd"</span>,index);</div><div class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">0.2</span>];</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    <span class="built_in">dispatch_async</span>(serialQueue, ^&#123;</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"task2--%@"</span>,[<span class="built_in">NSThread</span> currentThread]);</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    <span class="built_in">dispatch_async</span>(serialQueue, ^&#123;</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"task3--%@"</span>,[<span class="built_in">NSThread</span> currentThread]);</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    <span class="built_in">dispatch_async</span>(serialQueue, ^&#123;</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"task4--%@"</span>,[<span class="built_in">NSThread</span> currentThread]);</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    <span class="comment">// 嵌套异步串行执行，模拟相同串行队列下异步执行不创建线程情况</span></div><div class="line">    <span class="built_in">dispatch_async</span>(serialQueue, ^&#123;</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"task5 start"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"task5--%@"</span>,[<span class="built_in">NSThread</span> currentThread]);</div><div class="line">        <span class="comment">// 打开下面代码会创建新的线程</span></div><div class="line">        <span class="comment">//  serialQueue = dispatch_queue_create("anotherSerialQueue", DISPATCH_QUEUE_SERIAL);</span></div><div class="line">        <span class="built_in">dispatch_async</span>(serialQueue, ^&#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"task5.1--%@"</span>,[<span class="built_in">NSThread</span> currentThread]);</div><div class="line">        &#125;);</div><div class="line">        </div><div class="line">        <span class="built_in">dispatch_async</span>(serialQueue, ^&#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"task5.2--%@"</span>,[<span class="built_in">NSThread</span> currentThread]);</div><div class="line">        &#125;);</div><div class="line">        </div><div class="line">        <span class="built_in">dispatch_async</span>(serialQueue, ^&#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"task5.3--%@"</span>,[<span class="built_in">NSThread</span> currentThread]);</div><div class="line">        &#125;);</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> (<span class="built_in">NSInteger</span> index = <span class="number">0</span>; index &lt; <span class="number">5</span>; index++) &#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"task5--run%zd"</span>,index);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"task5 end"</span>);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">53</span>:<span class="number">38.777</span> MultiThreadDemo[<span class="number">1547</span>:<span class="number">113364</span>] task1--&lt;<span class="built_in">NSThread</span>: <span class="number">0x608000265ac0</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">53</span>:<span class="number">38.777</span> MultiThreadDemo[<span class="number">1547</span>:<span class="number">113364</span>] task1--run0</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">53</span>:<span class="number">38.978</span> MultiThreadDemo[<span class="number">1547</span>:<span class="number">113364</span>] task1--run1</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">53</span>:<span class="number">39.179</span> MultiThreadDemo[<span class="number">1547</span>:<span class="number">113364</span>] task1--run2</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">53</span>:<span class="number">39.383</span> MultiThreadDemo[<span class="number">1547</span>:<span class="number">113364</span>] task1--run3</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">53</span>:<span class="number">39.588</span> MultiThreadDemo[<span class="number">1547</span>:<span class="number">113364</span>] task1--run4</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">53</span>:<span class="number">39.790</span> MultiThreadDemo[<span class="number">1547</span>:<span class="number">113364</span>] task2--&lt;<span class="built_in">NSThread</span>: <span class="number">0x608000265ac0</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">53</span>:<span class="number">39.790</span> MultiThreadDemo[<span class="number">1547</span>:<span class="number">113364</span>] task3--&lt;<span class="built_in">NSThread</span>: <span class="number">0x608000265ac0</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">53</span>:<span class="number">39.791</span> MultiThreadDemo[<span class="number">1547</span>:<span class="number">113364</span>] task4--&lt;<span class="built_in">NSThread</span>: <span class="number">0x608000265ac0</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">53</span>:<span class="number">39.791</span> MultiThreadDemo[<span class="number">1547</span>:<span class="number">113364</span>] task5 start</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">53</span>:<span class="number">39.791</span> MultiThreadDemo[<span class="number">1547</span>:<span class="number">113364</span>] task5--&lt;<span class="built_in">NSThread</span>: <span class="number">0x608000265ac0</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">53</span>:<span class="number">39.791</span> MultiThreadDemo[<span class="number">1547</span>:<span class="number">113364</span>] task5--run0</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">53</span>:<span class="number">39.792</span> MultiThreadDemo[<span class="number">1547</span>:<span class="number">113364</span>] task5--run1</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">53</span>:<span class="number">39.792</span> MultiThreadDemo[<span class="number">1547</span>:<span class="number">113364</span>] task5--run2</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">53</span>:<span class="number">39.792</span> MultiThreadDemo[<span class="number">1547</span>:<span class="number">113364</span>] task5--run3</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">53</span>:<span class="number">39.792</span> MultiThreadDemo[<span class="number">1547</span>:<span class="number">113364</span>] task5--run4</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">53</span>:<span class="number">39.792</span> MultiThreadDemo[<span class="number">1547</span>:<span class="number">113364</span>] task5 end</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">53</span>:<span class="number">39.793</span> MultiThreadDemo[<span class="number">1547</span>:<span class="number">113364</span>] task5<span class="number">.1</span>--&lt;<span class="built_in">NSThread</span>: <span class="number">0x608000265ac0</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">53</span>:<span class="number">39.793</span> MultiThreadDemo[<span class="number">1547</span>:<span class="number">113364</span>] task5<span class="number">.2</span>--&lt;<span class="built_in">NSThread</span>: <span class="number">0x608000265ac0</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-17</span> <span class="number">23</span>:<span class="number">53</span>:<span class="number">39.793</span> MultiThreadDemo[<span class="number">1547</span>:<span class="number">113364</span>] task5<span class="number">.3</span>--&lt;<span class="built_in">NSThread</span>: <span class="number">0x608000265ac0</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</div></pre></td></tr></table></figure></p>
<p>异步串行执行情况下，最多可创建一条新的线程（同一个串行队列），当串行队列相同时不会创建新的线程如嵌套异步串行执行所演示。在同一个串行队列的任务依次执行，也可以从task5和其子任务可看出，task5比5.1，5.2，5.3先加入队列中，需要等task5任务结束之后再去执行其后的子任务。如果将注释代码打开<code>serialQueue = dispatch_queue_create(&quot;anotherSerialQueue&quot;, DISPATCH_QUEUE_SERIAL)</code>就可演示非同一个串行队列的任务不必等到当前任务执行完成才能执行，当然这属于异步的范畴本就该如此。打开注释打印log如下：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">43.213</span> MultiThreadDemo[<span class="number">1595</span>:<span class="number">119170</span>] task1--&lt;<span class="built_in">NSThread</span>: <span class="number">0x60800026df80</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">43.213</span> MultiThreadDemo[<span class="number">1595</span>:<span class="number">119170</span>] task1--run0</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">43.418</span> MultiThreadDemo[<span class="number">1595</span>:<span class="number">119170</span>] task1--run1</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">43.621</span> MultiThreadDemo[<span class="number">1595</span>:<span class="number">119170</span>] task1--run2</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">43.823</span> MultiThreadDemo[<span class="number">1595</span>:<span class="number">119170</span>] task1--run3</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">44.028</span> MultiThreadDemo[<span class="number">1595</span>:<span class="number">119170</span>] task1--run4</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">44.231</span> MultiThreadDemo[<span class="number">1595</span>:<span class="number">119170</span>] task2--&lt;<span class="built_in">NSThread</span>: <span class="number">0x60800026df80</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">44.231</span> MultiThreadDemo[<span class="number">1595</span>:<span class="number">119170</span>] task3--&lt;<span class="built_in">NSThread</span>: <span class="number">0x60800026df80</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">44.232</span> MultiThreadDemo[<span class="number">1595</span>:<span class="number">119170</span>] task4--&lt;<span class="built_in">NSThread</span>: <span class="number">0x60800026df80</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">44.232</span> MultiThreadDemo[<span class="number">1595</span>:<span class="number">119170</span>] task5 start</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">44.232</span> MultiThreadDemo[<span class="number">1595</span>:<span class="number">119170</span>] task5--&lt;<span class="built_in">NSThread</span>: <span class="number">0x60800026df80</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">44.233</span> MultiThreadDemo[<span class="number">1595</span>:<span class="number">119170</span>] task5--run0</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">44.233</span> MultiThreadDemo[<span class="number">1595</span>:<span class="number">119172</span>] task5<span class="number">.1</span>--&lt;<span class="built_in">NSThread</span>: <span class="number">0x60800026ddc0</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">44.233</span> MultiThreadDemo[<span class="number">1595</span>:<span class="number">119170</span>] task5--run1</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">44.233</span> MultiThreadDemo[<span class="number">1595</span>:<span class="number">119172</span>] task5<span class="number">.2</span>--&lt;<span class="built_in">NSThread</span>: <span class="number">0x60800026ddc0</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">44.234</span> MultiThreadDemo[<span class="number">1595</span>:<span class="number">119170</span>] task5--run2</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">44.234</span> MultiThreadDemo[<span class="number">1595</span>:<span class="number">119172</span>] task5<span class="number">.3</span>--&lt;<span class="built_in">NSThread</span>: <span class="number">0x60800026ddc0</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">44.234</span> MultiThreadDemo[<span class="number">1595</span>:<span class="number">119170</span>] task5--run3</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">44.234</span> MultiThreadDemo[<span class="number">1595</span>:<span class="number">119170</span>] task5--run4</div><div class="line"><span class="number">2017</span><span class="number">-04</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">44.235</span> MultiThreadDemo[<span class="number">1595</span>:<span class="number">119170</span>] task5 end</div></pre></td></tr></table></figure></p>
<p>异步+并行队列：会开启一条或多条线程，并行任务依次在各个线程中执行。</p>
<h5 id="线程间通信"><a href="#线程间通信" class="headerlink" title="线程间通信"></a>线程间通信</h5><h5 id="数据访问限制"><a href="#数据访问限制" class="headerlink" title="数据访问限制"></a>数据访问限制</h5><h4 id="NSOperation"><a href="#NSOperation" class="headerlink" title="NSOperation"></a><a id="NSOperation"></a>NSOperation</h4>
      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/实用技术/" rel="tag"># 实用技术</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/03/26/DataPersistence/" rel="next" title="DataPersistence For iOS">
                <i class="fa fa-chevron-left"></i> DataPersistence For iOS
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/04/27/发布开源框架到CocoaPods/" rel="prev" title="发布开源框架到CocoaPods图文详解">
                发布开源框架到CocoaPods图文详解 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2017/04/15/iOS多线程的使用总结/"
           data-title="iOS多线程的使用总结" data-url="http://yoursite.com/2017/04/15/iOS多线程的使用总结/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://github.com/CoderHann/imageSource/blob/master/Blog/blog_usr_icon.jpeg?raw=true"
               alt="CoderHann" />
          <p class="site-author-name" itemprop="name">CoderHann</p>
          <p class="site-description motion-element" itemprop="description">运气就是机会碰巧撞到了你的努力!</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/CoderHann" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="/about" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#多线程简介"><span class="nav-number">1.</span> <span class="nav-text">多线程简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生活中的多线程"><span class="nav-number">2.</span> <span class="nav-text">生活中的多线程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#iOS多线程的分类以及详解"><span class="nav-number">3.</span> <span class="nav-text">iOS多线程的分类以及详解</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#概述"><span class="nav-number">3.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pthread"><span class="nav-number">3.2.</span> <span class="nav-text">pthread</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NSThread"><span class="nav-number">3.3.</span> <span class="nav-text">NSThread</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#NSThread基础用法"><span class="nav-number">3.3.1.</span> <span class="nav-text">NSThread基础用法</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#NSThread的实例化"><span class="nav-number">3.3.1.1.</span> <span class="nav-text">NSThread的实例化</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#NSThread常用属性-amp-方法"><span class="nav-number">3.3.1.2.</span> <span class="nav-text">NSThread常用属性&方法</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#线程的生命周期"><span class="nav-number">3.3.2.</span> <span class="nav-text">线程的生命周期</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#NSThread线程间的通讯"><span class="nav-number">3.3.3.</span> <span class="nav-text">NSThread线程间的通讯</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#NSThread数据访问控制-同步"><span class="nav-number">3.3.4.</span> <span class="nav-text">NSThread数据访问控制/同步</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#GCD"><span class="nav-number">3.4.</span> <span class="nav-text">GCD</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#GCD相关概念"><span class="nav-number">3.4.1.</span> <span class="nav-text">GCD相关概念</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#GCD基础"><span class="nav-number">3.4.2.</span> <span class="nav-text">GCD基础</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#队列"><span class="nav-number">3.4.2.1.</span> <span class="nav-text">队列</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#同步异步执行"><span class="nav-number">3.4.2.2.</span> <span class="nav-text">同步异步执行</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#线程间通信"><span class="nav-number">3.4.3.</span> <span class="nav-text">线程间通信</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#数据访问限制"><span class="nav-number">3.4.4.</span> <span class="nav-text">数据访问限制</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NSOperation"><span class="nav-number">3.5.</span> <span class="nav-text">NSOperation</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CoderHann</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"coderHannComment"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  













  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("sAmDOA290qPW0l1mKlFvIjHU-gzGzoHsz", "1WQhXLWP9nAqbCsLhMqqMoCF");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  


</body>
</html>
